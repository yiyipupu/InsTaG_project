<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>å®æ—¶å¯¹è¯ - Zootopia</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main/css/style.css') }}?v=2.0">
</head>

<body class="bg-chat">
    <a href="/" class="nav-back">â¬… è¿”å›é¦–é¡µ</a>

    <h2>ğŸ¤ åŠ¨ç‰©åŸå¹¿æ’­ç«™ (Live Chat)</h2>

    <div class="video-page-container">
        <div class="video-display">

            <!-- çŠ¶æ€æç¤º -->
            <div id="statusMessage" style="margin-bottom:10px; color:#777; font-size:1.1rem;">
                å‡†å¤‡å°±ç»ª
            </div>

            <!-- å½•éŸ³è®¡æ—¶å™¨ -->
            <div id="timer" style="font-size:1.5rem; font-weight:bold; color:#555; margin-bottom:10px;">
                00:00
            </div>

            <!-- è§†é¢‘æ’­æ”¾ -->
            <video id="chatVideo" controls>
                <source src="{{ url_for('static', filename='videos/sample.mp4') }}" type="video/mp4">
            </video>
        </div>

        <div class="form-section">
            <form id="chatForm">
                <div class="form-group">
                    <label>ğŸ“‚ æ¨¡å‹</label>
                    <select name="model_name">
                        <option value="InsTaG">InsTaG</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>ğŸ¦Š å½¢è±¡ (Avatar)</label>
                    <input type="text" name="model_param" placeholder="è¾“å…¥è·¯å¾„...">
                </div>

                <div class="form-group">
                    <label>ğŸ—£ï¸ å£°éŸ³å…‹éš† (Voice ID)</label>
                    <select name="voice_clone">
                        <option value="cloneA">Voice A (Cute)</option>
                        <option value="cloneB">Voice B (Deep)</option>
                    </select>
                </div>

                <!-- âœ… æ–°å¢ï¼šè¯´è¯é£æ ¼ -->
                <div class="form-group">
                    <label>ğŸ­ è¯´è¯é£æ ¼</label>
                    <select name="style">
                        <option value="normal" selected>æ­£å¸¸äºº</option>
                        <option value="toxic">æ¯’èˆŒ</option>
                        <option value="warm">æ¸©æš–å‹</option>
                    </select>
                </div>

                <!-- âŒ å·²åˆ é™¤ï¼šå¯¹è¯å¼•æ“ (API) -->

                <button type="submit" class="generate-btn">ğŸ’¬ å‘èµ·å¯¹è¯</button>
            </form>
        </div>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = []; 
        let isRecording = false;
        let startTime;
        let timerInterval;
        const timerDisplay = document.getElementById('timer');
        const statusMessage = document.getElementById('statusMessage');

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function updateTimer() {
            const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
            timerDisplay.textContent = formatTime(elapsedSeconds);
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const formData = new FormData();
                    formData.append('audio', audioBlob, 'input.wav');

                    const modelParam =
                        document.querySelector('#chatForm input[name="model_param"]').value || '';
                    formData.append('model_param', modelParam);

                    // âœ… æ–°å¢ï¼šåªä¼  styleï¼Œä¸æ”¹ä»»ä½•å…¶ä»–é€»è¾‘
                    const style =
                        document.querySelector('#chatForm select[name="style"]').value || 'normal';
                    formData.append('style', style);

                    statusMessage.textContent = 'æ­£åœ¨è¯†åˆ«å¹¶ç”Ÿæˆè§†é¢‘...';

                    fetch('/chat/start', {
                        method: 'POST',
                        body: formData
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'success') {
                            statusMessage.textContent = 'å¯¹è¯å®Œæˆ';

                            const videoEl = document.getElementById('chatVideo');
                            videoEl.src = data.video_path + '?t=' + Date.now();
                            videoEl.load();
                            videoEl.play();
                        }
                        else if (data.status === 'pending') {
                            statusMessage.textContent = data.msg || 'è§†é¢‘ä»åœ¨ç”Ÿæˆä¸­ï¼Œè¯·ç¨åæŸ¥çœ‹';
                        }
                        else {
                            statusMessage.textContent = data.msg || 'ç”Ÿæˆå¤±è´¥';
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        statusMessage.textContent = 'è¯·æ±‚å‡ºé”™';
                    });

                    stream.getTracks().forEach(t => t.stop());
                    if (audioContext) {
                        audioContext.close();
                        audioContext = null;
                    }
                };

                mediaRecorder.start();
                isRecording = true;
                statusMessage.textContent = 'æ­£åœ¨å½•éŸ³...';

                startTime = Date.now();
                timerInterval = setInterval(updateTimer, 1000);

                const audioContext = new AudioContext();
                const source = audioContext.createMediaStreamSource(stream);
                const analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                source.connect(analyser);

                const dataArray = new Uint8Array(analyser.fftSize);
                let silenceStart = Date.now();
                const silenceThreshold = 8;
                const silenceDuration = 1200;

                function detectSilence() {
                    analyser.getByteTimeDomainData(dataArray);

                    let sum = 0;
                    for (let i = 0; i < dataArray.length; i++) {
                        const v = dataArray[i] - 128;
                        sum += Math.abs(v);
                    }
                    const volume = sum / dataArray.length;

                    if (volume < silenceThreshold) {
                        if (Date.now() - silenceStart > silenceDuration) {
                            stopRecording();
                            return;
                        }
                    } else {
                        silenceStart = Date.now();
                    }

                    if (isRecording) {
                        requestAnimationFrame(detectSilence);
                    }
                }

                requestAnimationFrame(detectSilence);

            } catch (err) {
                console.error(err);
                statusMessage.textContent = 'æ— æ³•è®¿é—®éº¦å…‹é£';
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                isRecording = false;
                mediaRecorder.stop();
                clearInterval(timerInterval);
                statusMessage.textContent = 'å½•éŸ³ç»“æŸï¼Œæ­£åœ¨å¤„ç†...';
            }
        }

        document.getElementById('chatForm').addEventListener('submit', e => {
            e.preventDefault();
            statusMessage.textContent = 'æ­£åœ¨å‡†å¤‡å½•éŸ³...';
            startRecording();
        });
    </script>

</body>
</html>
